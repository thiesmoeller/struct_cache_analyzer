name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Install dependencies
        run: uv sync
      - name: Check Python syntax
        run: uv run python -m py_compile ds_cache_analyzer.py

  cpp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential dwarves linux-tools-generic
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake ..
      - name: Build
        run: |
          cd build
          cmake --build .
      - name: Install Python dependencies
        run: uv sync
      - name: Run example binary
        run: |
          cd build
          ./bin/example || true
      - name: Record perf data
        run: |
          cd build
          # Try perf mem first (may fail in CI without Intel PT, that's ok)
          if sudo perf mem record -t load ./bin/example 2>&1; then
            echo "perf mem succeeded"
          else
            echo "perf mem failed, trying cache-misses event"
            perf record -e cache-misses -g --call-graph dwarf -o perf.data ./bin/example
          fi
      - name: Generate perf script
        run: |
          cd build
          if [ -f perf.data ]; then
            perf script > perf_script.txt
            echo "Generated perf_script.txt with $(wc -l < perf_script.txt) lines"
          else
            echo "No perf.data found, creating minimal script for testing"
            echo "test_function 12345 [unknown] example_main.cpp:42" > perf_script.txt
          fi
      - name: Run cache analyzer (auto-infer)
        continue-on-error: true
        run: |
          cd build
          if [ -f perf_script.txt ] && [ -s perf_script.txt ]; then
            uv run python ../ds_cache_analyzer.py \
              --binary ./bin/example \
              --perf-script perf_script.txt \
              --auto-infer \
              --html report.html || echo "Auto-infer failed (expected if perf mem not available)"
          else
            echo "Skipping auto-infer: no perf data available"
          fi
      - name: Run cache analyzer (with mappings)
        run: |
          cd build
          uv run python ../ds_cache_analyzer.py \
            --binary ./bin/example \
            --perf-script perf_script.txt \
            --mappings ../examples/example_mappings.yml \
            --html report.html